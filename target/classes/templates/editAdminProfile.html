<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Notepad - Edit Admin Profile</title>
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/output.css" />
</head>
<body>
     <!-- Navbar -->
  <header
      class="fixed shadow-lg flex top-0  bg-ijomuda w-full justify-between z-30"
    >
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
    </style>
      <div class="flex items-stretch">
        <div class="py-2 px-4 max-md:hover:bg-ijotaik">
          <a class="" href="/">
            <img class="w-[125px]" src="/img/logo.png" />
          </a>
        </div>
      </div>

      <!--Navigation on left-->
      <div class="flex items-center mr-0 ml-auto max-md:hidden">
        <div
          class="p-3 font-inter font-semibold hover:bg-ijomudagelap border-b-[2px] border-ijomuda hover:border-black transition-all duration-300 ease-in-out"
        >
          <a href="/user/notes/upload" class="inline-block relative p-1">Upload</a>
        </div>
        <div
          class="p-3 font-inter font-semibold hover:bg-ijomudagelap border-b-[2px] border-ijomuda hover:border-black transition-all duration-300 ease-in-out"
        >
          <a href="/user/notes" class="inline-block relative p-1">MyNotes</a>
        </div>
        <div
          class="p-3 font-inter font-semibold hover:bg-ijomudagelap border-b-[2px] border-ijomuda hover:border-black transition-all duration-300 ease-in-out"
        >
          <a href="/user/notes/bookmark" class="inline-block relative p-1">Saved</a>
        </div>
      </div>
      </div>

      <!--SearchBar-->
      <div class="flex">
        
        <div class="p-3 max-md:hidden">
          <input
            id="search-input"
            type="text"
            class="border-greenwhitey rounded-lg p-1"
            placeholder="Search..."
          />
          <button
            class="pl-1"
            onclick="searchByName()"
            >
            <img class="w-4" src="/img/search.png" />
          </button>
          
      </div>
        <a class="p-2 flex items-center" href="/user/profile">
          <img id="profile-picture" src="/api/account/profile-photo" class="w-11 h-11 rounded-full border-[1px] border-gray-300" />
          <div class="border-sky-500"></div>
        </a>
      </div>
    </header>
    <script src="/js/navbar.js"></script>

    <!-- Main Content -->
    <main class="mx-auto max-w-6xl p-8 bg-white mt-4 rounded-lg">
        <h1 class="mb-8 text-4xl font-bold">Profile</h1>

        <form id="profileForm" class="grid grid-cols-1 gap-8 md:grid-cols-2">
            <!-- Left Column -->
            <div class="space-y-6">
                <div>
                    <h2 class="mb-4 text-xl font-bold">Avatar Profile</h2>
                    <div class="flex flex-col items-start">
                        <div id="profileImageContainer" class="mb-4 h-24 w-24 overflow-hidden rounded-full border flex items-center justify-center bg-white">
                            <img id="profileImage" class="h-full w-full object-cover hidden" alt="Profile Picture">
                            <svg id="profileIcon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <label for="profilePicture" class="text-black underline cursor-pointer">
                            Upload Picture
                        </label>
                        <input type="file" id="profilePicture" accept="image/*" class="hidden">
                        <!-- Hidden input to track if image was changed -->
                        <input type="hidden" id="imageChanged" value="false">
                    </div>
                </div>

                <div class="space-y-2">
                    <button type="button" id="linkedinBtn" class="flex items-center gap-2">
                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/mdi_linkedin-1kMkmeryjsjlD3Rnvvex4zuc38enni.png" alt="LinkedIn" class="w-6 h-6">
                        <span id="linkedinText">Add LinkedIn</span>
                    </button>
                    <button type="button" id="instagramBtn" class="flex items-center gap-2">
                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/iconsax-instagram-lr8l3JZrI0k0CSIaJSohbMZCCUNBqZ.png" alt="Instagram" class="w-6 h-6">
                        <span id="instagramText">Add Instagram</span>
                    </button>
                </div>

                <div>
                    <h2 class="mb-2 text-xl font-bold">About Me</h2>
                    <textarea name="aboutMe" id="aboutMe" class="h-40 w-full border border-gray-300 rounded-md p-2"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-4">
                <div>
                    <label class="mb-2 block font-medium">Username</label>
                    <input type="text" name="username" id="username" class="w-full border border-gray-300 rounded-md p-2">
                </div>

                <div>
                    <label class="mb-2 block font-medium">Full Name</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" name="firstName" id="firstName" placeholder="First Name" class="w-full border border-gray-300 rounded-md p-2">
                        <input type="text" name="lastName" id="lastName" placeholder="Last Name" class="w-full border border-gray-300 rounded-md p-2">
                    </div>
                </div>

                <div>
                    <label class="mb-2 block font-medium">E-mail</label>
                    <input type="email" name="email" id="email" class="w-full border border-gray-300 rounded-md p-2">
                </div>

                <div>
                    <label class="mb-2 block font-medium">Password</label>
                    <div class="relative">
                        <input type="password" name="password" id="password" class="w-full border border-gray-300 rounded-md p-2 pr-10">
                        <button type="button" id="togglePassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="mb-2 block font-medium">Repeat Password</label>
                    <div class="relative">
                        <input type="password" name="repeatPassword" id="repeatPassword" class="w-full border border-gray-300 rounded-md p-2 pr-10">
                        <button type="button" id="toggleRepeatPassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="passwordError" class="text-red-500 mt-1 text-sm hidden">Passwords do not match!</p>
                </div>

                <div class="flex justify-end pt-4 mt-8">
                    <button type="submit" id="updateProfileBtn" class="bg-emerald-400 px-6 py-2 text-black hover:bg-emerald-500 rounded-md">
                        Update Profile
                    </button>
                </div>
            </div>
        </form>

        <!-- LinkedIn Connect Modal -->
        <div id="linkedinModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Connect LinkedIn</h2>
                <p class="mb-4">Enter your LinkedIn username to connect your account:</p>
                <div class="mb-4">
                    <input type="text" id="linkedinUsername" class="w-full p-2 border border-gray-300 rounded-md" placeholder="LinkedIn Username">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelLinkedinBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="connectLinkedinBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Connect</button>
                </div>
            </div>
        </div>

        <!-- Instagram Connect Modal -->
        <div id="instagramModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Connect Instagram</h2>
                <p class="mb-4">Enter your Instagram username to connect your account:</p>
                <div class="mb-4">
                    <input type="text" id="instagramUsername" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Instagram Username">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelInstagramBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="connectInstagramBtn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-md hover:from-purple-600 hover:to-pink-600">Connect</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load admin data from localStorage
            const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
            
            // Populate form fields with existing data
            if (adminData.username) document.getElementById('username').value = adminData.username;
            if (adminData.firstName) document.getElementById('firstName').value = adminData.firstName;
            if (adminData.lastName) document.getElementById('lastName').value = adminData.lastName;
            if (adminData.email) document.getElementById('email').value = adminData.email;
            if (adminData.aboutMe) document.getElementById('aboutMe').value = adminData.aboutMe;
            
            // Display profile image if available
            if (adminData.profileImage) {
                // Update profile image in the form
                const profileImage = document.getElementById('profileImage');
                profileImage.src = adminData.profileImage;
                profileImage.classList.remove('hidden');
                document.getElementById('profileIcon').classList.add('hidden');
                
                // Update profile image in the navbar
                const navProfileImg = document.getElementById('navProfileImg');
                navProfileImg.src = adminData.profileImage;
                document.getElementById('profileNavImage').classList.remove('hidden');
                document.getElementById('profileNavIcon').classList.add('hidden');
            }
            
            // Update LinkedIn status
            if (adminData.linkedinUsername) {
                document.getElementById('linkedinText').textContent = adminData.linkedinUsername;
            }
            
            // Update Instagram status
            if (adminData.instagramUsername) {
                document.getElementById('instagramText').textContent = adminData.instagramUsername;
            }
            
            // Profile picture upload
            document.getElementById('profilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const profileImage = document.getElementById('profileImage');
                        profileImage.src = event.target.result;
                        profileImage.classList.remove('hidden');
                        document.getElementById('profileIcon').classList.add('hidden');
                        
                        // Mark that image was changed
                        document.getElementById('imageChanged').value = 'true';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Password visibility toggle
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                    `;
                } else {
                    passwordInput.type = 'password';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    `;
                }
            });
            
            // Repeat password visibility toggle
            document.getElementById('toggleRepeatPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('repeatPassword');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                    `;
                } else {
                    passwordInput.type = 'password';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    `;
                }
            });
            
            // Password validation
            function validatePasswords() {
                const password = document.getElementById('password').value;
                const repeatPassword = document.getElementById('repeatPassword').value;
                const errorElement = document.getElementById('passwordError');
                
                if (password && repeatPassword && password !== repeatPassword) {
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    errorElement.classList.add('hidden');
                    return true;
                }
            }
            
            document.getElementById('password').addEventListener('input', validatePasswords);
            document.getElementById('repeatPassword').addEventListener('input', validatePasswords);
            
            // LinkedIn connection
            document.getElementById('linkedinBtn').addEventListener('click', function() {
                const modal = document.getElementById('linkedinModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (adminData.linkedinUsername) {
                    document.getElementById('linkedinUsername').value = adminData.linkedinUsername;
                }
            });
            
            document.getElementById('cancelLinkedinBtn').addEventListener('click', function() {
                const modal = document.getElementById('linkedinModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            document.getElementById('connectLinkedinBtn').addEventListener('click', function() {
                const username = document.getElementById('linkedinUsername').value.trim();
                if (username) {
                    // Update UI
                    document.getElementById('linkedinText').textContent = username;
                    
                    // Close modal
                    document.getElementById('linkedinModal').classList.add('hidden');
                }
            });
            // Instagram connection
            document.getElementById('instagramBtn').addEventListener('click', function() {
                const modal = document.getElementById('instagramModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (adminData.instagramUsername) {
                    document.getElementById('instagramUsername').value = adminData.instagramUsername;
                }
            });
            
            document.getElementById('cancelInstagramBtn').addEventListener('click', function() {
                const modal = document.getElementById('instagramModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            document.getElementById('cancelInstagramBtn').addEventListener('click', function() {
                document.getElementById('instagramModal').classList.add('hidden');
            });
            
            document.getElementById('connectInstagramBtn').addEventListener('click', function() {
                const username = document.getElementById('instagramUsername').value.trim();
                if (username) {
                    // Update UI
                    document.getElementById('instagramText').textContent = username;
                    
                    // Close modal
                    document.getElementById('instagramModal').classList.add('hidden');
                }
            });
            
            // Form submission
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Validate passwords if both fields have values
                const password = document.getElementById('password').value;
                const repeatPassword = document.getElementById('repeatPassword').value;
                
                if ((password || repeatPassword) && !validatePasswords()) {
                    return; // Don't submit if passwords don't match
                }
                
                // Get form data
                const formData = {
                    username: document.getElementById('username').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    aboutMe: document.getElementById('aboutMe').value,
                    linkedinUsername: document.getElementById('linkedinText').textContent === 'Add LinkedIn' ? null : document.getElementById('linkedinText').textContent,
                    instagramUsername: document.getElementById('instagramText').textContent === 'Add Instagram' ? null : document.getElementById('instagramText').textContent,
                    isAdmin: true
                };
                
                // Add password if provided
                if (password) {
                    formData.password = password;
                } else if (adminData.password) {
                    // Keep existing password if not changed
                    formData.password = adminData.password;
                }
                
                // Handle profile image
                const profileImage = document.getElementById('profileImage');
                const imageChanged = document.getElementById('imageChanged').value === 'true';
                
                // If image is visible and either it was changed or there was an image before
                if (!profileImage.classList.contains('hidden')) {
                    try {
                        // Try to get the image data with reduced quality to avoid localStorage limits
                        if (imageChanged) {
                            // Create a canvas to resize the image
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 300; // Max width for the image
                            
                            // Set canvas dimensions
                            let width = profileImage.naturalWidth;
                            let height = profileImage.naturalHeight;
                            
                            // Calculate new dimensions
                            if (width > maxWidth) {
                                const ratio = maxWidth / width;
                                width = maxWidth;
                                height = height * ratio;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Draw image on canvas with new dimensions
                            ctx.drawImage(profileImage, 0, 0, width, height);
                            
                            // Get compressed image data
                            formData.profileImage = canvas.toDataURL('image/jpeg', 0.7); // Reduce quality to 70%
                        } else {
                            // Keep existing image if not changed
                            formData.profileImage = adminData.profileImage;
                        }
                    } catch (error) {
                        console.error('Error processing image:', error);
                        // If there's an error, try to use the original image
                        formData.profileImage = profileImage.src;
                    }
                }
                
                // Save data to localStorage
                try {
                    localStorage.setItem('adminData', JSON.stringify(formData));
                    // Redirect to profile page
                    window.location.href = 'adminProfile.html';
                } catch (error) {
                    console.error('Error saving data:', error);
                    // If localStorage fails (possibly due to size limits), show an error
                    alert('Failed to save data. Try using a smaller image.');
                }
            });
        });
    </script>
</body>
</html>